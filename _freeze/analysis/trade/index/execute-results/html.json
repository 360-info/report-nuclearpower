{
  "hash": "bd16c1eb24067afbad99bddf903515ba",
  "result": {
    "markdown": "---\ntitle: Trade of nuclear commodities\nsubtitle: Tracking the commodities used to produce nuclear power\nformat:\n  360-analysis-html: default\nauthor: James Goldie\ndate: last-modified\ncode-fold: true\n---\n\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.5.0     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nhere() starts at /workspaces/report-nuclearpower\n```\n\n\n:::\n:::\n\n\nFirst, let's download the data from the [European Commission](https://data.jrc.ec.europa.eu/collection/id-00366):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_url <-\n  \"https://cidportal.jrc.ec.europa.eu/ftp/jrc-opendata/NUCLEAR-TRADE-ATLAS/\"\ndest_path <- here(\"data\", \"raw\")\n\nfiles <- tibble(\n  file = \"NUCLEAR_TRADE_ATLAS_DATA_2023.zip\",\n  url = paste0(base_url, file),\n  dest = file.path(dest_path, file))\n\n# download and unzip the files if the csvs don't exist\nif (!all(file.exists(files$dest))) {\n  dir.create(dest_path, showWarnings = FALSE)\n  files |>\n    mutate(\n      dl = walk2(url, dest, download.file),\n      unzip = walk(dest, unzip, exdir = dest_path))\n}\n```\n:::\n\n\nLet's open the two files up:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntibble(\n  path = list.files(dest_path, pattern = glob2rx(\"*.csv\"), full.names = TRUE)) |>\n  mutate(data = map(path, read_csv)) |>\n  unnest(data) |>\n  janitor::clean_names() ->\nall_data\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 96210 Columns: 13\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (10): COMMODITY DESCRIPTION, FLOW, NUCLEAR COMMODITY DESCRIPTION, PARTNE...\ndbl  (3): COMMODITY CODE, QUANTITY KG, VALUE USD\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n\nNigel Marks from Curtin University has helped us classify the commodities described in the `commodity_code`, `commodity_description` and `nuclear_commodity_description` columns.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhere(\"data\", \"nuclear-commodity-categories.csv\") |>\n  read_csv() |>\n  print() |>\n  select(-nuclear_commodity_description) ->\ncategories\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 22 Columns: 3\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (2): nuclear_commodity_description, category\ndbl (1): commodity_code\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 22 × 3\n   commodity_code nuclear_commodity_description     category                    \n            <dbl> <chr>                             <chr>                       \n 1          2844. Radioactive elements and isotopes Unclear - perhaps ignore    \n 2          8401. Fuel elements, non-irradiated     Fuel fabrication            \n 3          8102. Tungsten articles                 Ignore - probably related t…\n 4          8112. Beryllium                         Probably ignore             \n 5          8112. Beryllium                         Probably ignore             \n 6          8112. Beryllium                         Probably ignore             \n 7          2844. Depleted uranium; thorium         Enrichment                  \n 8          2844. Enriched uranium; plutonium       Enrichment                  \n 9          2845. Heavy water                       Power Plant                 \n10          2844. Irradiated fuel elements          Spent Fuel / HLW            \n# ℹ 12 more rows\n```\n\n\n:::\n:::\n\n\nWe'll have a look at the commodities marked \"Ignore\" as well to see how they big they are, but we're approaching on the assumption that they're mostly not related to fission.\n\nLet's merge those categories in:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_data |>\n  left_join(categories, join_by(commodity_code), multiple = \"all\",\n    unmatched = \"error\") |>\n  glimpse() ->\njoined_data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 96,210\nColumns: 15\n$ path                          <chr> \"/workspaces/report-nuclearpower/data/ra…\n$ commodity_code                <dbl> 2844.40, 8401.30, 8101.99, 8101.99, 2844…\n$ commodity_description         <chr> \"Radioactive elements, isotopes and comp…\n$ flow                          <chr> \"Export\", \"Export\", \"Export\", \"Export\", …\n$ nuclear_commodity_description <chr> \"Radioactive elements and isotopes\", \"Fu…\n$ partner                       <chr> \"Libya\", \"Sudan\", \"Niger\", \"Ethiopia\", \"…\n$ partner_iso2                  <chr> \"LY\", \"SD\", \"NE\", \"ET\", \"DZ\", \"EG\", \"MA\"…\n$ partner_iso3                  <chr> \"LBY\", \"SDN\", \"NER\", \"ETH\", \"DZA\", \"EGY\"…\n$ period                        <chr> \"12/31/2017\", \"12/31/2017\", \"12/31/2017\"…\n$ reporter                      <chr> \"Tunisia\", \"Egypt\", \"Algeria\", \"Egypt\", …\n$ reporter_iso2                 <chr> \"TN\", \"EG\", \"DZ\", \"EG\", \"ZA\", \"ZA\", \"ZA\"…\n$ reporter_iso3                 <chr> \"TUN\", \"EGY\", \"DZA\", \"EGY\", \"ZAF\", \"ZAF\"…\n$ quantity_kg                   <dbl> 231, 0, 90, 1, 10, 272, 108, 100, 1, 968…\n$ value_usd                     <dbl> 69653, 30, 164, 32, 53930, 20071, 19889,…\n$ category                      <chr> \"Unclear - perhaps ignore\", \"Fuel fabric…\n```\n\n\n:::\n:::\n\n\nWe'll also rearrange the countries slightly. In Comtrade, the database from which this Atlas is derived:\n\n- **exports** are trades from the reporter to the partner (ie. the reporter in the source and the partner is the recipient), while\n- **imports** go from the partner to the reporter (ie. the reporter is the recipient and the partner is the source).\n\nLet's derive the `source` and `recipient`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\njoined_data |>\n  mutate(\n    source = if_else(flow == \"Export\", reporter, partner),\n    source_iso3 = if_else(flow == \"Export\", reporter_iso3, partner_iso3),\n    recipient = if_else(flow == \"Export\", partner, reporter),\n    recipient_iso3 = if_else(flow == \"Export\", partner_iso3, reporter_iso3)) ->\nmapped_data\n```\n:::\n\n\nNow we'll sum up commodities within each category (still split by year and by trading partners):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapped_data |>\n  # lump all the \"ignore\" categories together\n  mutate(category = if_else(\n    str_detect(category, fixed(\"ignore\", ignore_case = TRUE)),\n    \"Ignore\",\n    category)) |>\n  # all period dates are dec 31 for that year\n  mutate(year = year(mdy(period))) |>\n  # sum up all commodities within category\n  group_by(source, source_iso3, recipient, recipient_iso3, year, category, flow) |>\n  summarise(\n    value_usd = sum(value_usd, na.rm = TRUE)) |>\n  ungroup() |>\n  select(-flow) |>\n  distinct(.keep_all = TRUE) |>\n  write_csv(here(\"data\", \"nuclear-commodity-data.csv\")) ->\ncategory_data\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'source', 'source_iso3', 'recipient',\n'recipient_iso3', 'year', 'category'. You can override using the `.groups`\nargument.\n```\n\n\n:::\n:::\n\n\nNow let's sum it up across years, too:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncategory_data |>\n  group_by(source, source_iso3, recipient, recipient_iso3, category) |>\n  summarise(sum_value_usd = sum(value_usd, na.rm = TRUE)) |>\n  ungroup() |>\n  write_csv(here(\"data\", \"nuclear-commodity-data-allyears2023.csv\")) ->\nallyears_data\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'source', 'source_iso3', 'recipient',\n'recipient_iso3'. You can override using the `.groups` argument.\n```\n\n\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}